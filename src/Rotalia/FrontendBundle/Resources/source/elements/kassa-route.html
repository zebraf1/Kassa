<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="kassa-behavior.html">

<dom-module id="kassa-route">
	<template>
		<app-location route="{{route}}" use-hash-as-path></app-location>
		<app-route route="{{route}}"
		           pattern="/:page"
		           data="{{routeData}}"></app-route>
	</template>
	<script>
        Polymer({
            is: "kassa-route",
            properties: {
                member: {
                    type: Object
                },
                page: {
                    type: String,
                    notify: true,
                    readOnly: true
                },
                navigation: {
                    type: Array
                },
                routeData: {
                    type: Object,
                    notify: false
                }
            },
            observers: ['_computePage(routeData, member, navigation)'],
            behaviors: [KassaBehavior],
            _computePage: function (routeData, member, navigation) {
                var _default = navigation[0].page;

                //Pole sisse logitud?
                if (!this.isTrue(member)) {
                    this._setPage('login');
                    if (routeData.page === 'logout') {
                        this.set('routeData.page', 'login');
                    }
                    return null
                }

                if (this.isTrue(routeData) && routeData.page) {
                    //Kas on sobivate Ãµigustega??
                    for (var i = 0; i < navigation.length; i++) {
                        if (routeData.page === navigation[i].page && member.roles.indexOf(navigation[i].role) >= 0) {
                            this._setPage(routeData.page);
                            return null
                        }
                    }

                    //Logout pole osa navigationist (login ka mitte)
                    if (routeData.page === 'logout') {
                        this._setPage('logout');
                        return null
                    }
                }

                //Kui muud ei leia
                this._setPage(_default);
                return null
            }
        })
	</script>
</dom-module>
