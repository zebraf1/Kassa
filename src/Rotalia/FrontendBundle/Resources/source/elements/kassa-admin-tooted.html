<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<link rel="import" href="kassa-page-behavior.html">
<link rel="import" href="kassa-behavior.html">
<link rel="import" href="kassa-confirm-button.html">
<link rel="import" href="kassa-table.html">
<link rel="import" href="kassa-material.html">


<dom-module id="kassa-admin-tooted">
	<template>
		<style>
		</style>
		<kassa-table items="[[products]]" edit-func="doProductsPatch" add-func="doProductsPost" dialog="[[dialog]]"
		             convent-id="[[conventId]]" scroll-target="[[scrollTarget]]" row-details="kassa-admin-tooted">
			<vaadin-grid-column flex-grow="0">
				<template class="header">Id</template>
				<template>
					<span class$="[[item.status]]" style="text-align: right;">[[item.id]]</span>
				</template>
			</vaadin-grid-column>
			<vaadin-grid-column flex-grow="10">
				<template class="header">
					<vaadin-grid-filter path="name" value="{{_nameFilter}}">
						<paper-input label="Nimi" value="{{_nameFilter}}" slot="filter"></paper-input>
					</vaadin-grid-filter>
				</template>
				<template>
					<span class$="[[item.status]]">[[item.name]]</span>
				</template>
			</vaadin-grid-column>
			<vaadin-grid-column flex-grow="0">
				<template class="header">Suurus</template>
				<template>
					<span class$="[[item.status]]" style="text-align: right;">[[formatAmount(item.amount, item.amountType)]]</span>
				</template>
			</vaadin-grid-column>
			<vaadin-grid-column flex-grow="0">
				<template class="header">Grupp</template>
				<template>
					<span class$="[[item.status]]">[[_computeProductGroup(item.productGroupId, productGroups)]]</span>
				</template>
			</vaadin-grid-column>
			<vaadin-grid-column flex-grow="0">
				<template class="header">Hind</template>
				<template>
					<span class$="[[item.status]]" style="text-align: right;">[[eur2str(item.price)]]</span>
				</template>
			</vaadin-grid-column>
		</kassa-table>

		<paper-dialog id="dialog" modal style="max-width: 350px">
			<kassa-material direction="vertical">
				<paper-input data-field="name" label="Nimi" type="text"></paper-input>
				<div style="display: flex; flex-flow: row nowrap; align-items: flex-end">
					<paper-input data-field="amount" label="Suurus" type="number" min="0"
					             style="flex: 1 1 50%"></paper-input>
					<vaadin-combo-box data-field="amountType" label="Ühik" item-label-path="label"
					                  item-value-path="value" items="[[productAmountTypeNames]]"
					                  style="flex: 1 1 40%; padding-left: 0.8em"></vaadin-combo-box>
				</div>
				<vaadin-combo-box data-field="productGroupId" label="Grupp" item-label-path="name" item-value-path="id"
				                  items="[[productGroups]]"></vaadin-combo-box>
				<paper-input data-field="price" label="Hind (€)" type="number" min="0" step="0.1"></paper-input>
				<paper-toggle-button data-field="status">Käibel?</paper-toggle-button>
			</kassa-material>
			<div class="buttons">
				<paper-button dialog-dismiss raised>Sulge</paper-button>
				<kassa-confirm-button style="margin-right: 16px">Salvesta</kassa-confirm-button>
			</div>
		</paper-dialog>

	</template>
	<script>
        Polymer({
            is: "kassa-admin-tooted",
            properties: {
                conventId: {
                    type: Number
                },
                activeProducts: {
                    type: Array
                },
                inactiveProducts: {
                    type: Array
                },
                products: {
                    type: Array,
                    computed: '_merge(activeProducts.*, inactiveProducts.*)'
                },
                productGroups: {
                    type: Array
                },
                dialog: {
                    type: Node
                }
            },
            behaviors: [PageBehavior, KassaBehavior],
            observers: ['_loadProducts(pageActive, conventId)'],
            ready: function () {
                this.set('dialog', this.$.dialog);
            },
	        setUp: function () {
                this.fire('kassa-backend-action', {action: 'doProductGroupsGet'});
            },
	        cleanUp: function() {
                this.set('activeProducts', []);
                this.set('inactiveProducts', []);
	        },
            _loadProducts: function (pageActive, conventId) {
                if (pageActive) {
                    this.cleanUp();
                    this.fire('kassa-backend-action', {action: 'doProductsGetAll', conventId: conventId});
                }
            },
            _merge: function (array1, array2) {
                if ((array1.base !== undefined) && (array2.base !== undefined)) {
                    return array1.base.concat(array2.base)
                } else {
                    return [];
                }

            },
            _computeProductGroup: function (productGroupId, productGroups) {
                if ((productGroupId !== undefined) && (productGroups !== undefined)) {
                    for (var i = 0; i < productGroups.length; i++) {
                        if (productGroups[i].id === productGroupId) {
                            return productGroups[i].name
                        }
                    }
                }
                return ''
            }
        })
	</script>
</dom-module>



