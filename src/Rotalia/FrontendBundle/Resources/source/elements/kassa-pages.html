<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/lazy-imports/lazy-imports-behavior.html">

<link rel="import" href="kassa-loading-page.html">
<link rel="import" href="kassa-behavior.html">

<dom-module id="kassa-pages">
    <link rel="lazy-import" group="login" href="kassa-login.html">
    <link rel="lazy-import" group="logout" href="kassa-logout.html">
    <link rel="lazy-import" group="ost" href="kassa-ost.html">
    <link rel="lazy-import" group="admin-tooted" href="kassa-admin-tooted.html">
    <link rel="lazy-import" group="admin-tootegrupid" href="kassa-admin-tootegrupid.html">
    <link rel="lazy-import" group="admin-kassad" href="kassa-admin-kassad.html">
    <template>
        <style>
            main {
                height: 100%;
                width: 100%;
                display: block;
                padding: 1em;
                overflow: auto;
                box-sizing: border-box;
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                -ms-box-sizing: border-box;
                -o-box-sizing: border-box;
            }

        </style>

        <main>
            <neon-animated-pages selected="[[shown]]" attr-for-selected="data-page" selected-item="{{selectedItem}}"
                                 entry-animation="fade-in-animation" exit-animation="fade-out-animation">
                <kassa-loading-page data-page="loading"></kassa-loading-page>
                <content></content>
            </neon-animated-pages>
        </main>

    </template>
    <script>
        Polymer({
            is: "kassa-pages",

            properties: {
                selected: {
                    type: String,
                    observer: '_onSelectedChange'
                },
                shown: {
                    type: String,
                    value: 'loading',
                    readOnly: true
                },
                selectedItem: {
                    type: Object,
                    observer: '_onPageChange'
                },
                height: {
                    type: Number,
                    observer: '_changeHeight'
                },
                scrollTarget: {
                    type: HTMLElement,
                    notify: true,
                    readOnly: true
                },
                _scrollTargetContainer: {
                    type: HTMLElement
                }
            },
            behaviors: [KassaBehavior, Polymer.LazyImportsBehavior],
            _onSelectedChange: function (newPage, oldPage) {
                this._setShown('loading');
                this.importLazyGroup(newPage).then(function() {
                    this._setShown(newPage);
                    this.fire('kassa-page-loaded');
                }.bind(this));
            },
            _onPageChange: function (newPage, oldPage) {
                //kassa-page-behavior
                if(newPage && newPage.sharedSetUp){
                    newPage.sharedSetUp();
                }

                if(oldPage && oldPage.sharedCleanUp){
                    oldPage.sharedCleanUp();
                }

                if (this.isTrue(this.selectedItem)) {
                    var scrollTargetContainer = this.selectedItem.getScrollTarget();
                    if (scrollTargetContainer) {
                        this._setScrollTarget(scrollTargetContainer.$.scroller.scrollTarget);
                        this.set('_scrollTargetContainer', scrollTargetContainer);
                    } else {
                        this._setScrollTarget(this.$$('main'));
                        this.set('_scrollTargetContainer', null);
                    }
                }
            },
            _changeHeight: function (newHeight) {
                this.$$('main').style.height = newHeight + 'px';
                if (this.isTrue(this._scrollTargetContainer)) {
                    var style = this.$$('main').currentStyle || window.getComputedStyle(this.$$('main'));
                    var padding = parseFloat(style.paddingTop) + parseFloat(style.paddingBottom) ;
                    // Kahega korrutatud, et saada lahti topelt scrollbarist. Kuskilt hiilivad lisapikslid sisse.
                    this._scrollTargetContainer.style.height = this.$$('main').clientHeight - 2*padding + 'px';
                }
            }
        })
    </script>
</dom-module>
