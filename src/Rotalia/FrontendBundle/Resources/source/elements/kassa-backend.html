<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="kassa-behavior.html">

<dom-module id="kassa-backend">
	<template>
		<!-- Authentication -->
		<iron-ajax id="authenticationDelete" handle-as="json" url='[[_computeURL("authentication")]]' method="DELETE"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="authenticationGet" handle-as="json" url='[[_computeURL("authentication")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="authenticationPost" handle-as="json" url='[[_computeURL("authentication")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- Settings -->
		<iron-ajax id="settingsGet" handle-as="json" url='[[_computeURL("settings")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- Members -->
		<iron-ajax id="membersGet" handle-as="json" url='[[_computeURL("members")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- Products -->
		<iron-ajax id="productsGet" handle-as="json" url='[[_computeURL("products")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="productsPost" handle-as="json" url='[[_computeURL("products")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="productsPatch" handle-as="json" url='[[_computeURL("products", _id)]]' method="PATCH"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- ProductGroups -->
		<iron-ajax id="productGroupsGet" handle-as="json" url='[[_computeURL("productGroups")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="productGroupsPost" handle-as="json" url='[[_computeURL("productGroups")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="productGroupsPatch" handle-as="json" url='[[_computeURL("productGroups", _id)]]' method="PATCH"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- PointOfSales -->
		<iron-ajax id="pointOfSalesGet" handle-as="json" url='[[_computeURL("pointOfSales")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="pointOfSalesPost" handle-as="json" url='[[_computeURL("pointOfSales")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="pointOfSalesPatch" handle-as="json" url='[[_computeURL("pointOfSales", _id)]]' method="PATCH"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="pointOfSalesDelete" handle-as="json" url='[[_computeURL("pointOfSales", _id)]]' method="DELETE"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- Purchase -->
		<iron-ajax id="purchasePost" handle-as="json" url='[[_computeURL("purchase", "credit")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- Report -->
		<iron-ajax id="reportGet" handle-as="json" url='[[_computeURL("reports")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<! -- Transactions -->
		<iron-ajax id="transactionsGet" handle-as="json" url='[[_computeURL("purchase", "refund")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="transactionsPost" handle-as="json" url='[[_computeURL("purchase", "refund")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
	</template>
	<script>
        Polymer({
            is: 'kassa-backend',
            properties: {
                _id: {
                    type: Number
                },
                /* Authentication */
                member: {
                    type: Object,
                    notify: true,
                    readOnly: true
                },
                csrfToken: {
                    type: String,
                    notify: true,
                    readOnly: true
                },
                /* Settings */
                settings: {
                    type: Object,
                    notify: true,
                    readOnly: true
                },
                /* Members */
                members: {
                    type: Array,
                    notify: true,
                    readOnly: true
                },
                /* Products */
                activeProducts: {
                    type: Array,
                    notify: true,
                    readOnly: true
                },
                inactiveProducts: {
                    type: Array,
                    notify: true,
                    readOnly: true
                },
                /* ProductGroups */
                productGroups: {
                    type: Array,
                    notify: true,
                    readOnly: true
                },
                /* PointOfSales */
                pointOfSales: {
                    type: Array,
                    notify: true,
                    readOnly: true
                },
                /* Reports */
                lastReport: {
                    type: Object,
                    notify: true,
                    readOnly: true
                },
	            /* Transactions */
	            transactions: {
                    type: Array,
                    notify: true,
                    readOnly: true
	            }
            },
            listeners: {
                'error': '_onRequestError'
            },
            behaviors: [KassaBehavior],
            attached: function () {
                this.doAuthenticationGet();
            },
            /* Authentication */
            doLogin: function (username, password) {
                this.$.authenticationPost.set('body', {
                    username: username,
                    password: password,
                    csrfToken: this.csrfToken
                });
                return this.$.authenticationPost.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this.fire('kassa-message-success', data);
                    return this.doAuthenticationGet();
                }.bind(this))
            },
            doLogout: function () {
                return this.$.authenticationDelete.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this.fire('kassa-message-success', data);
                    return this.doAuthenticationGet();
                }.bind(this));
            },
            doAuthenticationGet: function () {
                return this.$.authenticationGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    if (data.csrfToken) {
                        this._setCsrfToken(data.csrfToken);
                        this._setMember(null);
                    } else {
                        this._setCsrfToken(null);
                        this._setMember(data.member);
                        this.doSettingsGet();
                    }
                }.bind(this))
            },
            /* Settings */
            doSettingsGet: function () {
                return this.$.settingsGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setSettings(data);
                }.bind(this))
            },
            /* Members */
            doMembersGet: function () {
                this.$.membersGet.set('params', {limit: 0});
                this.$.membersGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setMembers(data.members);
                }.bind(this))
            },
            /* Products */
            doProductsGetAll: function (conventId) {
                return Promise.all([this.doProductsGetActive(conventId), this.doProductsGetInactive(conventId)])
            },
            doProductsGetActive: function (conventId) {
                this.$.productsGet.set('params', {conventId: conventId, active: true});
                return this.$.productsGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setActiveProducts(data.products);
                }.bind(this))
            },
            doProductsGetInactive: function (conventId) {
                this.$.productsGet.set('params', {conventId: conventId, active: false});
                return this.$.productsGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setInactiveProducts(data.products);
                }.bind(this))
            },
            doProductsPost: function (conventId, productType) {
                this.$.productsPost.set('body', this._formatBody({conventId: conventId, ProductType: productType}));
                return this.$.productsPost.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    if (data['status'] === 'ACTIVE') {
                        this.push('activeProducts', data.product);
                    } else {
                        this.push('inactiveProducts', data.product);
                    }
                    this.fire('kassa-message-success', 'Toode edukalt lisatud');
                }.bind(this))
            },
            doProductsPatch: function (conventId, productId, productType) {
                this.$.productsPatch.set('body', this._formatBody({conventId: conventId, ProductType: productType}));
                this.set('_id', productId);
                return this.$.productsPatch.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    if (this._updateItems('activeProducts', this.activeProducts, data.product) || this._updateItems('inactiveProducts', this.inactiveProducts, data.product)) {
                        this.fire('kassa-message-success', 'Toode edukalt muudetud');
                    }
                }.bind(this))
            },
            /* ProductGroups */
            doProductGroupsGet: function () {
                return this.$.productGroupsGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setProductGroups(data.productGroups);
                }.bind(this))
            },
            doProductGroupsPost: function (ProductGroupType) {
                this.$.productGroupsPost.set('body', this._formatBody({ProductGroupType: ProductGroupType}));
                return this.$.productGroupsPost.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this.push('productGroups', data.productGroup);
                    this.fire('kassa-message-success', 'Tootegrupp edukalt lisatud');
                }.bind(this))
            },
            doProductGroupsPatch: function (productGroupId, ProductGroupType) {
                this.$.productGroupsPatch.set('body', this._formatBody({ProductGroupType: ProductGroupType}));
                this.set('_id', productGroupId);
                return this.$.productGroupsPatch.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._updateItems('productGroups', this.productGroups, data.productGroup);
                    this.fire('kassa-message-success', 'Tootegrupp edukalt muudetud');
                }.bind(this))
            },
            /* PointOfSales */
            doPointOfSalesGet: function () {
                return this.$.pointOfSalesGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setPointOfSales(data.pointOfSales);
                }.bind(this))
            },
            doPointOfSalesPost: function (conventId, PointOfSaleType) {
                this.$.pointOfSalesPost.set('body', this._formatBody({
                    conventId: conventId,
                    PointOfSaleType: PointOfSaleType
                }));
                return this.$.pointOfSalesPost.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this.push('pointOfSales', data.pointOfSale);
                    this.fire('kassa-message-success', 'Müügipunkt edukalt lisatud');
                }.bind(this))
            },
            doPointOfSalesPatch: function (pointOfSaleId, PointOfSaleType) {
                this.$.pointOfSalesPatch.set('body', this._formatBody({PointOfSaleType: PointOfSaleType}));
                this.set('_id', pointOfSaleId);
                return this.$.pointOfSalesPatch.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._updateItems('pointOfSales', this.pointOfSales, data.pointOfSale);
                    this.fire('kassa-message-success', 'Müügipunkt edukalt muudetud');
                }.bind(this))
            },
            doPointOfSalesDelete: function (pointOfSaleId) {
                this.set('_id', pointOfSaleId);
                return this.$.pointOfSalesDelete.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    console.log('TODO', data);
                    this.fire('kassa-message-success', 'Müügipunkt edukalt kustutatud');
                }.bind(this))
            },
            /* Purchase */
            doPurchasePost: function (conventId, memberId, basket) {
                this.$.purchasePost.set('body', this._formatBody({
                    conventId: conventId,
                    memberId: memberId,
                    basket: basket
                }));
                return this.$.purchasePost.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this.fire('kassa-message-success', 'Ost edukalt sooritatud');
                    //Laeme kasutaja krediidi uuesti (vb pole vaja, kui bug parandatud)
                    return this.doAuthenticationGet();
                }.bind(this))
            },
	        /* Reports */
            doLastReportGet: function (conventId) {
                this.$.reportGet.set('body', this._formatBody({
                    conventId: conventId,
                    reportType: 'VERIFICATION',
                    limit: 1
                }));
                return this.$.reportGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    if (data.length === 1) {
                        this.set('lastReport', data[0]);
                    } else {
                        this.set('lastReport', null);
                    }
                }.bind(this))
            },
	        /* Transactions */
            doTransactionsGet: function (conventId) {
                this.$.transactionsGet.set('params', {conventId: conventId});
                return this.$.transactionsGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setTransactions(data.purchases);
                }.bind(this))
            },
            /* General */
            doAction: function (data) {
                var promise;
                switch (data.action) {
                    /* Authentication */
                    case 'doLogin':
                        promise = this.doLogin(data.username, data.password);
                        break;
                    case 'doLogout':
                        promise = this.doLogout();
                        break;
                    case 'doAuthenticationGet':
                        promise = this.doAuthenticationGet();
                        break
                    /* Members */
                    case 'doMembersGet':
                        promise = this.doMembersGet();
                        break;
                    /* Products */
                    case 'doProductsGetAll':
                        promise = this.doProductsGetAll(data.conventId);
                        break;
                    case 'doProductsGetActive':
                        promise = this.doProductsGetActive(data.conventId);
                        break;
                    case 'doProductsPost':
                        promise = this.doProductsPost(data.conventId, data.itemType);
                        break;
                    case 'doProductsPatch':
                        promise = this.doProductsPatch(data.conventId, data.id, data.itemType);
                        break;
                    /* ProductGroups */
                    case 'doProductGroupsGet':
                        promise = this.doProductGroupsGet();
                        break;
                    case 'doProductGroupsPost':
                        promise = this.doProductGroupsPost(data.itemType);
                        break;
                    case 'doProductGroupsPatch':
                        promise = this.doProductGroupsPatch(data.id, data.itemType);
                        break;
                    /* PointOfSales */
                    case 'doPointOfSalesGet':
                        promise = this.doPointOfSalesGet();
                        break;
                    case 'doPointOfSalesPost':
                        promise = this.doPointOfSalesPost(data.conventId, data.itemType);
                        break;
                    case 'doPointOfSalesPatch':
                        promise = this.doPointOfSalesPatch(data.id, data.itemType);
                        break;
                    case 'doPointOfSalesDelete':
                        promise = this.doPointOfSalesDelete(data.id);
                        break;
                    /* Purchases */
                    case 'doPurchasePost':
                        promise = this.doPurchasePost(data.conventId, data.memberId, data.basket);
                        break;
                    /* Reports */
                    case 'doLastReportGet':
                        promise = this.doLastReportGet(data.conventId);
                        break;
	                /* Transactions */
	                case 'doTransactionsGet':
                        promise = this.doTransactionsGet(data.conventId);
                        break;
                    /* General */
                    default:
                        console.error('Vale action.', data);
                }

                if (promise) {
                    promise.then(function () {
                        if (data.onSuccess) {
                            data.onSuccess.call();
                        }
                    }, function (error) {
                        if (data.onError) {
                            data.onError.call();
                        } else {
                            console.error(error);
                        }
                    });
                }
            },
            _formatBody: function (body) {
                var newBody = {};
                for (var key in body) {
                    if (body.hasOwnProperty(key) && this.isTrue(body[key])) {
                        if (body[key].constructor === Object) {
                            for (var key2 in body[key]) {
                                if (body[key].hasOwnProperty(key2)) {
                                    newBody[key + '[' + key2 + ']'] = body[key][key2];
                                }
                            }
                        } else if (Array.isArray(body[key])) {
                            for (let i = 0; i < body[key].length; i++) {
                                for (var key2 in body[key][i]) {
                                    if (body[key][i].hasOwnProperty(key2)) {
                                        newBody[key + '[' + i + ']' + '[' + key2 + ']'] = body[key][i][key2];
                                    }
                                }
                            }
                        } else {
                            newBody[key] = body[key];
                        }
                    }
                }
                return newBody
            },
            _checkSuccess: function (result) {
                if (result.xhr.response && result.xhr.response.status === 'success') {
                    return result.xhr.response.data;
                } else {
                    console.error('Vigane vastus serverilt.', result);
                }
            },
            _checkError: function (event) {
                if (event.detail.request.xhr.response) {
                    if (event.detail.request.xhr.response.status === 'fail' || event.detail.request.xhr.response.status === 'error') {
                        return event.detail.request.xhr.response.message;
                    } else {
                        console.error('Vigane vastus serverilt.', event);
                    }
                } else {
                    console.error('Ei saanud vastust serverilt.', event);
                }

                return 'Tekkis tundmatu viga.'
            },
            _computeURL: function (endpoint, id) {
                if (typeof id === 'undefined') {
                    return '/api/' + endpoint + '/'
                } else {
                    return '/api/' + endpoint + '/' + id + '/'
                }

            },
            _onRequestError: function (event) {
                event.stopPropagation();
                this.fire('kassa-message-error', this._checkError(event));
            },
            _updateItems: function (itemsPath, items, newItem) {
                for (var i = 0; i < items.length; i++) {
                    if (items[i]['id'] === newItem['id']) {
                        this.set(itemsPath + '.' + i, newItem);
                        return true
                    }
                }
                return false
            }
        })

	</script>
</dom-module>
