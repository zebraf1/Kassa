<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="kassa-behavior.html">

<dom-module id="kassa-backend">
	<template>
		<!-- Authentication -->
		<iron-ajax id="authenticationDelete" handle-as="json" url='[[_computeURL("authentication")]]' method="DELETE"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="authenticationGet" handle-as="json" url='[[_computeURL("authentication")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="authenticationPost" handle-as="json" url='[[_computeURL("authentication")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- Settings -->
		<iron-ajax id="settingsGet" handle-as="json" url='[[_computeURL("settings")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- Members -->
		<iron-ajax id="membersGet" handle-as="json" url='[[_computeURL("members")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- Products -->
		<iron-ajax id="productsGet" handle-as="json" url='[[_computeURL("products")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="productsPost" handle-as="json" url='[[_computeURL("products")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="productsPatch" handle-as="json" url='[[_computeURL("products", _id)]]' method="PATCH"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- ProductGroups -->
		<iron-ajax id="productGroupsGet" handle-as="json" url='[[_computeURL("productGroups")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="productGroupsPost" handle-as="json" url='[[_computeURL("productGroups")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="productGroupsPatch" handle-as="json" url='[[_computeURL("productGroups", _id)]]' method="PATCH"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- PointOfSales -->
		<iron-ajax id="pointOfSalesGet" handle-as="json" url='[[_computeURL("pointOfSales")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="pointOfSalesPost" handle-as="json" url='[[_computeURL("pointOfSales")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="pointOfSalesPatch" handle-as="json" url='[[_computeURL("pointOfSales", _id)]]' method="PATCH"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="pointOfSalesDelete" handle-as="json" url='[[_computeURL("pointOfSales", _id)]]' method="DELETE"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- Purchase -->
		<iron-ajax id="purchasesGet" handle-as="json" url='[[_computeURL("purchase")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="purchasePost" handle-as="json" url='[[_computeURL("purchase", "credit")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- Report -->
		<iron-ajax id="reportGet" handle-as="json" url='[[_computeURL("reports", _id)]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="reportsPost" handle-as="json" url='[[_computeURL("reports")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- Transfers -->
		<iron-ajax id="transfersGet" handle-as="json" url='[[_computeURL("transfers")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="transfersPost" handle-as="json" url='[[_computeURL("transfers")]]' method="POST"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<!-- Credit Nettings -->
		<iron-ajax id="creditNettingsGet" handle-as="json" url='[[_computeURL("creditNettings")]]' method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
		<iron-ajax id="creditNettingsPatch" handle-as="json" url='[[_computeURL("creditNettings", _id)]]' method="PATCH"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>
	</template>
	<script>
        Polymer({
            is: 'kassa-backend',
            properties: {
                _id: {
                    type: Number
                },
                /* Authentication */
                member: {
                    type: Object,
                    notify: true,
                    readOnly: true
                },
                csrfToken: {
                    type: String,
                    notify: true,
                    readOnly: true
                },
	            /* Members */
                members: {
                    type: Array,
                    notify: true,
                    readOnly: true
                },
                /* Settings */
                settings: {
                    type: Object,
                    notify: true,
                    readOnly: true
                },
                /* Products */
                activeProducts: {
                    type: Array,
                    notify: true,
                    readOnly: true
                },
                inactiveProducts: {
                    type: Array,
                    notify: true,
                    readOnly: true
                },
                /* ProductGroups */
                productGroups: {
                    type: Array,
                    notify: true,
                    readOnly: true
                },
                /* PointOfSales */
                pointOfSales: {
                    type: Array,
                    notify: true,
                    readOnly: true
                },
                /* Reports */
                singleReport: {
                    type: Object,
                    notify: true,
                    readOnly: true
                },
	            updates: {
                    type: Object,
                    notify: true,
                    readOnly: true
                },
	            reports: {
                    type: Array,
		            notify: true,
		            readOnly: true
	            },
	            /* Transactions */
                transfers: {
                    type: Array,
                    notify: true,
                    readOnly: true
	            },
	            /* CreditNettings */
	            creditNettings: {
                    type: Array,
                    notify: true,
                    readOnly: true
	            },
	            /* Purchases */
	            purchases: {
	                type: Array,
		            notify: true,
		            readOnly: true
	            }
            },
            listeners: {
                'error': '_onRequestError'
            },
            behaviors: [KassaBehavior],
            /* Authentication */
            doLogin: function (username, password, rememberMe) {
                this.$.authenticationPost.set('body', this._formatBody({
                    username: username,
                    password: password,
                    rememberMe: rememberMe,
                    csrfToken: this.csrfToken
                }));
                return this.$.authenticationPost.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this.fire('kassa-message-success', data);
                    return this.doAuthenticationGet();
                }.bind(this))
            },
            doLogout: function () {
                return this.$.authenticationDelete.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this.fire('kassa-message-success', data);
                    this._setCsrfToken(null);
                    this._setMember(null);
                }.bind(this));
            },
            doAuthenticationGet: function () {
                return this.$.authenticationGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    if (data.csrfToken) {
                        this._setCsrfToken(data.csrfToken);
                        this._setMember(null);
                    } else {
                        this._setCsrfToken(null);
                        this._setMember(data.member);
                        this.doSettingsGet();
                    }
                }.bind(this))
            },
            /* Settings */
            doSettingsGet: function () {
                return this.$.settingsGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setSettings(data);
                }.bind(this))
            },
	        /* Members */
	        doMembersGet: function (conventId, isActive) {
                this.$.membersGet.set('params', this._formatBody({
	                conventId: conventId,
	                isActive: isActive,
	                limit: 0
                }));
                return this.$.membersGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setMembers(data.members);
                }.bind(this))
            },
            /* Products */
            doProductsGetAll: function (conventId) {
                return Promise.all([this.doProductsGetActive(conventId), this.doProductsGetInactive(conventId)])
            },
            doProductsGetActive: function (conventId) {
                this.$.productsGet.set('params', this._formatBody({
	                conventId: conventId,
	                active: true
                }));
                return this.$.productsGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setActiveProducts(data.products);
                }.bind(this))
            },
            doProductsGetInactive: function (conventId) {
                this.$.productsGet.set('params', this._formatBody({
	                conventId: conventId,
	                active: false
                }));
                return this.$.productsGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setInactiveProducts(data.products);
                }.bind(this))
            },
            doProductsPost: function (conventId, productType) {
                this.$.productsPost.set('body', this._formatBody({
		                conventId: conventId,
	                    ProductType: productType
                }));
                return this.$.productsPost.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    if (data['status'] === 'ACTIVE') {
                        this.push('activeProducts', data.product);
                    } else {
                        this.push('inactiveProducts', data.product);
                    }
                    this.fire('kassa-message-success', 'Toode edukalt lisatud');
                }.bind(this))
            },
            doProductsPatch: function (conventId, productId, productType) {
                this.$.productsPatch.set('body', this._formatBody({
	                conventId: conventId,
	                ProductType: productType
                }));
                this.set('_id', productId);
                return this.$.productsPatch.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    if (this._updateItems('activeProducts', this.activeProducts, data.product) || this._updateItems('inactiveProducts', this.inactiveProducts, data.product)) {
                        this.fire('kassa-message-success', 'Toode edukalt muudetud');
                    }
                }.bind(this))
            },
            /* ProductGroups */
            doProductGroupsGet: function () {
                return this.$.productGroupsGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setProductGroups(data.productGroups);
                }.bind(this))
            },
            doProductGroupsPost: function (ProductGroupType) {
                this.$.productGroupsPost.set('body', this._formatBody({
	                ProductGroupType: ProductGroupType
                }));
                return this.$.productGroupsPost.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this.push('productGroups', data.productGroup);
                    this.fire('kassa-message-success', 'Tootegrupp edukalt lisatud');
                }.bind(this))
            },
            doProductGroupsPatch: function (productGroupId, ProductGroupType) {
                this.$.productGroupsPatch.set('body', this._formatBody({
	                ProductGroupType: ProductGroupType
                }));
                this.set('_id', productGroupId);
                return this.$.productGroupsPatch.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._updateItems('productGroups', this.productGroups, data.productGroup);
                    this.fire('kassa-message-success', 'Tootegrupp edukalt muudetud');
                }.bind(this))
            },
            /* PointOfSales */
            doPointOfSalesGet: function () {
                return this.$.pointOfSalesGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setPointOfSales(data.pointOfSales);
                }.bind(this))
            },
            doPointOfSalesPost: function (conventId, PointOfSaleType) {
                this.$.pointOfSalesPost.set('body', this._formatBody({
                    conventId: conventId,
                    PointOfSaleType: PointOfSaleType
                }));
                return this.$.pointOfSalesPost.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this.push('pointOfSales', data.pointOfSale);
                    this.fire('kassa-message-success', 'Müügipunkt edukalt lisatud');
                }.bind(this))
            },
            doPointOfSalesPatch: function (pointOfSaleId, PointOfSaleType) {
                this.$.pointOfSalesPatch.set('body', this._formatBody({
	                PointOfSaleType: PointOfSaleType
                }));
                this.set('_id', pointOfSaleId);
                return this.$.pointOfSalesPatch.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._updateItems('pointOfSales', this.pointOfSales, data.pointOfSale);
                    this.fire('kassa-message-success', 'Müügipunkt edukalt muudetud');
                }.bind(this))
            },
            doPointOfSalesDelete: function (pointOfSaleId) {
                this.set('_id', pointOfSaleId);
                return this.$.pointOfSalesDelete.generateRequest().completes.then(this._checkSuccess).then(function () {
                    this._deleteItems('pointOfSales', this.pointOfSales, pointOfSaleId);
                    this.fire('kassa-message-success', 'Müügipunkt edukalt kustutatud');
                }.bind(this))
            },
            /* Purchase */
            doPurchasePost: function (conventId, memberId, basket) {
                this.$.purchasePost.set('body', this._formatBody({
                    conventId: conventId,
                    memberId: memberId,
                    basket: basket
                }));
                return this.$.purchasePost.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this.fire('kassa-message-success', 'Ost edukalt sooritatud');
                    if (memberId === this.member.id) {
                        this.set('member.creditBalance', data.newCredit);
                    }
                }.bind(this))
            },
            doPurchasesGet: function (conventId, memberId, dateFrom, dateUntil) {
                this.$.purchasesGet.set('params', this._formatBody({
		            conventId: conventId,
	                memberId: memberId,
	                limit: 0,
	                dateFrom: dateFrom,
	                dateUntil: dateUntil
                }));
                return this.$.purchasesGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setPurchases(data.purchases);
                }.bind(this))
            },
	        /* Reports */
            doSingleReportGet: function (conventId, reportId, target, reportType) {
                this.set('_id', reportId);
                this.$.reportGet.set('params', this._formatBody({
                    conventId: conventId,
                    target: target,
                    reportType: reportType
                }));
                return this.$.reportGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setSingleReport(data.report);
                    this._setUpdates(data.updates);
                }.bind(this))
            },
	        doReportsGet: function (conventId, target, reportType, dateFrom, dateUntil) {
                this.set('_id', null);
                this.$.reportGet.set('params', this._formatBody({
                    conventId: conventId,
                    target: target,
                    reportType: reportType,
                    dateFrom: dateFrom,
                    dateUntil: dateUntil,
	                limit: 0
                }));
                return this.$.reportGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setReports(data.reports);
                }.bind(this))
            },
            doReportPost: function(conventId, Report, cashOut){
                this.$.reportsPost.set('body', this._formatBody({
                    conventId: conventId,
                    type: 'VERIFICATION',
                    Report: Report,
	                cashOut: cashOut
                }));
                return this.$.reportsPost.generateRequest().completes.then(this._checkSuccess).then(function () {
                    this.fire('kassa-message-success', 'Aruanne edukalt lisatud');
                }.bind(this))
            },
            doDeliveryPost: function(conventId, itemType) {
                this.$.reportsPost.set('body', this._formatBody({
                    conventId: conventId,
                    type: 'UPDATE',
                    Report: itemType
                }));
                return this.$.reportsPost.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this.unshift('reports', data.report);
                    this.fire('kassa-message-success', 'Tarne edukalt lisatud');
                }.bind(this))
            },
	        /* Transfers */
            doTransfersGet: function (conventId, memberId, dateFrom, dateUntil) {
                this.$.transfersGet.set('params', this._formatBody({
                    conventId: conventId,
	                memberId: memberId,
	                limit: 0,
	                dateFrom: dateFrom,
	                dateUntil: dateUntil
                }));
                return this.$.transfersGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setTransfers(data.transfers);
                }.bind(this))
            },
            doTransfersPost: function (conventId, TransferType) {
                this.$.transfersPost.set('body', this._formatBody({
                    conventId: conventId,
                    TransferType: TransferType
                }));
                return this.$.transfersPost.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this.unshift('transfers', data.transfer);
                    this.fire('kassa-message-success', 'Ülekanne edukalt lisatud');
                    return this.doAuthenticationGet();
                }.bind(this))
            },
	        /* CreditNettings */
	        doCreditNettingsGet: function () {
                return this.$.creditNettingsGet.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._setCreditNettings(data.creditNettings);
                }.bind(this))
            },
            doCreditNettingsPatch: function (conventId, creditNettingId, CreditNettingRowType) {
                this.$.creditNettingsPatch.set('body', this._formatBody({
		                CreditNettingRowType: CreditNettingRowType,
	                    conventId: conventId
                }));
                this.set('_id', creditNettingId);
                return this.$.creditNettingsPatch.generateRequest().completes.then(this._checkSuccess).then(function (data) {
                    this._updateItems('creditNettings', this.creditNettings, data.creditNetting);
                    this.fire('kassa-message-success', 'Tasaarveldus edukalt muudetud');
                }.bind(this))
            },
            /* General */
            doAction: function (data) {
                let promise;
                switch (data.action) {
                    /* Authentication */
                    case 'doLogin':
                        promise = this.doLogin(data.username, data.password, data.rememberMe);
                        break;
                    case 'doLogout':
                        promise = this.doLogout();
                        break;
                    case 'doAuthenticationGet':
                        promise = this.doAuthenticationGet();
                        break;
	                /* Members */
	                case 'doMembersGet':
	                    promise = this.doMembersGet(data.conventId, data.isActive);
	                    break;
                    /* Products */
                    case 'doProductsGetAll':
                        promise = this.doProductsGetAll(data.conventId);
                        break;
                    case 'doProductsGetActive':
                        promise = this.doProductsGetActive(data.conventId);
                        break;
                    case 'doProductsPost':
                        promise = this.doProductsPost(data.conventId, data.itemType);
                        break;
                    case 'doProductsPatch':
                        promise = this.doProductsPatch(data.conventId, data.id, data.itemType);
                        break;
                    /* ProductGroups */
                    case 'doProductGroupsGet':
                        promise = this.doProductGroupsGet();
                        break;
                    case 'doProductGroupsPost':
                        promise = this.doProductGroupsPost(data.itemType);
                        break;
                    case 'doProductGroupsPatch':
                        promise = this.doProductGroupsPatch(data.id, data.itemType);
                        break;
                    /* PointOfSales */
                    case 'doPointOfSalesGet':
                        promise = this.doPointOfSalesGet();
                        break;
                    case 'doPointOfSalesPost':
                        promise = this.doPointOfSalesPost(data.conventId, data.itemType);
                        break;
                    case 'doPointOfSalesPatch':
                        promise = this.doPointOfSalesPatch(data.id, data.itemType);
                        break;
                    case 'doPointOfSalesDelete':
                        promise = this.doPointOfSalesDelete(data.id);
                        break;
                    /* Purchases */
                    case 'doPurchasesGet':
                        promise = this.doPurchasesGet(data.conventId, data.memberId, data.dateFrom, data.dateUntil);
                        break;
                    case 'doPurchasePost':
                        promise = this.doPurchasePost(data.conventId, data.memberId, data.basket);
                        break;
                    /* Reports */
                    case 'doSingleReportGet':
                        promise = this.doSingleReportGet(data.conventId, data.id, data.target, data.reportType);
                        break;
	                case 'doReportsGet':
                        promise = this.doReportsGet(data.conventId, data.target, data.reportType, data.dateFrom, data.dateUntil);
                        break;
	                case 'doReportPost':
                        promise = this.doReportPost(data.conventId, data.Report, data.cashOut);
                        break;
	                case 'doDeliveryPost':
	                    promise = this.doDeliveryPost(data.conventId, data.itemType);
	                    break;
	                /* Transfers */
	                case 'doTransfersGet':
                        promise = this.doTransfersGet(data.conventId, data.memberId, data.dateFrom, data.dateUntil);
                        break;
	                case 'doTransfersPost':
	                    promise = this.doTransfersPost(data.conventId, data.itemType);
	                    break;
	                /* CreditNettings*/
	                case 'doCreditNettingsGet':
                        promise = this.doCreditNettingsGet();
                        break;
	                case 'doCreditNettingsPatch':
	                    promise = this.doCreditNettingsPatch(data.conventId, data.creditNettingId, data.creditNettingRowType);
	                    break;
                    /* General */
                    default:
                        console.error('Vale action.', data);
                }

                if (promise) {
                    promise.then(function () {
                        if (data.onSuccess) {
                            data.onSuccess.call();
                        }
                    }, function (error) {
                        if (data.onError) {
                            data.onError.call();
                        } else {
                            // On else sees, kuna ei taha uuesti proovida kõiki päringuid. Näiteks POST purcache.
                            if (typeof error === 'object') {
                                this.async(function () {
                                    this.doAction(data);
                                }.bind(this), 500);
                            }
                        }
                    }.bind(this));
                }
            },
            _formatBody: function (body, inner) {
                if (inner === undefined) {
                    inner = false;
                }


                const newBody = {};
                for (let key in body) {
                    if (body.hasOwnProperty(key)) {

                        if (body[key] === null || body[key] === undefined || body[key] === '') {
                            continue;
                        }


                        if (body[key].constructor === Object) {
                            var innerBody = this._formatBody(body[key], true);
                            for (var innerKey in innerBody) {
                                if (innerBody.hasOwnProperty(innerKey)) {
                                    if (inner) {
                                        newBody['[' + key + ']' + innerKey] = innerBody[innerKey];
                                    } else {
                                        newBody[key + innerKey] = innerBody[innerKey];
                                    }

                                }
                            }
                        } else if (Array.isArray(body[key])) {
                            for (let i = 0; i < body[key].length; i++) {
                                var innerBody = this._formatBody(body[key][i], true);
                                for (var innerKey in innerBody) {
                                    if (innerBody.hasOwnProperty(innerKey)) {
                                        if (inner) {
                                            newBody['[' + key + ']' + '[' + i + ']' + innerKey] = innerBody[innerKey];
                                        } else {
                                            newBody[key + '[' + i + ']' + innerKey] = innerBody[innerKey];
                                        }

                                    }
                                }
                            }
                        } else {
                            if (inner) {
                                newBody['[' + key + ']'] = body[key];
                            } else {
                                newBody[key] = body[key];
                            }
                        }
                    }
                }
                return newBody
            },
            _checkSuccess: function (result) {
                if (result.xhr.response && result.xhr.response.status === 'success') {
                    return result.xhr.response.data;
                } else {
                    console.error('Vigane vastus serverilt.', result);
                }
            },
            _checkError: function (event) {
                if (event.detail.request.xhr.response) {
                    if (event.detail.request.xhr.response.status === 'fail' || event.detail.request.xhr.response.status === 'error') {
                        return event.detail.request.xhr.response;
                    } else {
                        console.error(event);
                        return {message: 'Vigane vastus serverilt'};
                    }
                } else {
                    return {message: 'Ei saanud vastust serverilt'};
                }
            },
            _computeURL: function (endpoint, id) {
                if (id === undefined || id === null) {
                    return '/api/' + endpoint + '/'
                } else {
                    return '/api/' + endpoint + '/' + id + '/'
                }

            },
            _onRequestError: function (event) {
                event.stopPropagation();

                const response = this._checkError(event);
                this.fire('kassa-message-error', {message: response.message, data: response.data});
            },
            _updateItems: function (itemsPath, items, newItem) {
                for (let i = 0; i < items.length; i++) {
                    if (items[i]['id'] === newItem['id']) {
                        this.set(itemsPath + '.' + i, newItem);
                        return true
                    }
                }
                return false
            },
	        _deleteItems: function (itemsPath, items, id) {
                for (let i = 0; i < items.length; i++) {
                    if (items[i]['id'] === id) {
                        this.splice(itemsPath, i, 1);
                        return true
                    }
                }
                return false
            }
        })

	</script>
</dom-module>
