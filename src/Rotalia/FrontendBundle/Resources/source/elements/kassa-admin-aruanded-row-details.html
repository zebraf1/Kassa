<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="kassa-behavior.html">

<link rel="import" href="kassa-confirm-button.html">

<dom-module id="kassa-admin-aruanded-row-details">
	<template>
		<style>
			main {
				font-size: 13px;
				padding-left: 1em;
			}

			[hidden] {
				display: none;
			}
		</style>

		<main hidden$='[[_isHidden(rowDetailsInfo)]]'>
			<table>
				<thead>
					<tr>
						<th>Toode</th>
						<th>Suurus</th>
						<th>Alguses</th>
						<th>Juurde</th>
						<th>VÃ¤lja</th>
						<th>Eeldatav</th>
						<th>Tegelik</th>
					</tr>
				</thead>
				<tbody>
					<template is="dom-repeat" items="[[rows]]" as="row">
						<tr>
							<td>[[row.name]]</td>
							<td style="text-align: right">[[row.amount]]</td>
							<td style="text-align: right">[[row.startCount]]</td>
							<td style="text-align: right">[[row.inCount]]</td>
							<td style="text-align: right">[[row.outCount]]</td>
							<td style="text-align: right">[[row.estimatedCount]]</td>
							<td style="text-align: right">[[row.count]]</td>
						</tr>
					</template>
				</tbody>
			</table>
		</main>

	</template>
	<script>
        Polymer({
            is: "kassa-admin-aruanded-row-details",
            properties: {
                item: {
                    type: Object,
	                observer: '_rowExpanded'
                },
                rowDetailsInfo: {
                    type: Object
                },
	            rows: {
                    type: Array,
		            computed: '_computeRows(rowDetailsInfo.report, rowDetailsInfo.updates)'
	            }
            },
            behaviors: [KassaBehavior],
            _isHidden: function (rowDetailsInfo) {
                if (this.isTrue(rowDetailsInfo)) {
                    return (rowDetailsInfo.name !== 'kassa-admin-aruanded');
                }

                return true;
            },
            _rowExpanded: function(item) {
                if (this.isTrue(item) && !this._isHidden(this.rowDetailsInfo)) {
                    this.fire('kassa-backend-action', {
                        action: 'doSingleReportGet',
                        id: item.id
                    });
                }
            },
            _computeRows: function (report, updates) {
                if (report !== undefined && updates !== undefined && !this._isHidden(this.rowDetailsInfo)) {
                    var rows = [];

                    for (var i=0; i<report.reportRows.length; i++) {
                        var row = {};

                        row.name = report.reportRows[i].product.name;
                        row.amount = this.formatAmount(report.reportRows[i].product.amount, report.reportRows[i].product.amountType);
                        row.startCount = 0;
                        for (var j=0; j<report.previousReport.reportRows.length; j++) {
                            if (report.reportRows[i].product.id == report.previousReport.reportRows[j].product.id) {
                                row.startCount = report.previousReport.reportRows[j].count;
                                break;
                            }
                        }
                        row.inCount = 0;
                        row.outCount = 0;
                        if (updates.products.hasOwnProperty(report.reportRows[i].product.id)) {
                            row.inCount = updates.products[report.reportRows[i].product.id].in;
                            row.outCount = updates.products[report.reportRows[i].product.id].out;
                        }
                        row.estimatedCount = row.startCount + row.inCount - row.outCount;
	                    row.count = report.reportRows[i].count;
                        rows.push(row);
                    }

                    return rows;
                }
            }
        })
	</script>
</dom-module>
