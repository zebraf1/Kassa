<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="kassa-behavior.html">
<link rel="import" href="kassa-row-details-behavior.html">

<dom-module id="kassa-admin-aruanded-row-details">
	<template>
		<style>
			main {
				font-size: 13px;
				padding-left: 1em;
				width: 100%;
			}

			tbody td {
				text-align: right;
			}

			tbody td:first-child {
				text-align: left;
			}

			[hidden] {
				display: none;
			}
		</style>

		<iron-ajax id="reportGet"
		           url="/api/reports/[[item.id]]"
		           loading="{{loading}}"
		           handle-as="json"
		           method="GET"
		           content-type="application/x-www-form-urlencoded"></iron-ajax>

		<main hidden$='[[isHidden]]'>
			<paper-spinner active hidden$="[[!loading]]" style="height:25px; width: 25px; margin: 0 auto;"></paper-spinner>
			<table hidden$="[[loading]]">
				<thead>
					<tr>
						<th>Toode</th>
						<th>Suurus</th>
						<th>Alguses</th>
						<th>Juurde</th>
						<th>VÃ¤lja</th>
						<th>Eeldatav</th>
						<th>Tegelik</th>
					</tr>
				</thead>
				<tbody>
					<template is="dom-repeat" items="[[rows]]" as="row">
						<tr>
							<td>[[row.name]]</td>
							<td>[[row.amount]]</td>
							<td>[[row.startCount]]</td>
							<td>[[row.inCount]]</td>
							<td>[[row.outCount]]</td>
							<td>[[row.estimatedCount]]</td>
							<td>[[row.count]]</td>
						</tr>
					</template>
				</tbody>
			</table>
		</main>

	</template>
	<script>
        Polymer({
            is: "kassa-admin-aruanded-row-details",
            properties: {
                name: {
                    type: String,
	                value: 'kassa-admin-aruanded'
                },
	            rows: {
                    type: Array
                }
            },
            behaviors: [KassaBehavior, RowDetailsBehavior],
            rowActivated: function (callback) {
                this.$.reportGet.generateRequest().completes.then(function (result) {
                    var data = result.xhr.response.data;
                    this.set('rows', this._computeRows(data.report, data.updates));
                    this.async(function () {
                        callback()
                    });
                }.bind(this));
            },
            _computeRows: function (report, updates) {
                var rows = [];

                for (var i=0; i<report.reportRows.length; i++) {
                    var row = {};

                    row.name = report.reportRows[i].product.name;
                    row.amount = this.formatAmount(report.reportRows[i].product.amount, report.reportRows[i].product.amountType);
                    row.startCount = 0;
                    if (this.isTrue(report.previousReport)) {
                        for (var j = 0; j < report.previousReport.reportRows.length; j++) {
                            if (report.reportRows[i].product.id == report.previousReport.reportRows[j].product.id) {
                                row.startCount = report.previousReport.reportRows[j].count;
                                break;
                            }
                        }
                    }
                    row.inCount = 0;
                    row.outCount = 0;
                    if (updates.products.hasOwnProperty(report.reportRows[i].product.id)) {
                        row.inCount = updates.products[report.reportRows[i].product.id].in;
                        row.outCount = updates.products[report.reportRows[i].product.id].out;
                    }
                    row.estimatedCount = row.startCount + row.inCount - row.outCount;
                    row.count = report.reportRows[i].count;
                    rows.push(row);
                }

                return rows;
            }
        })
	</script>
</dom-module>
