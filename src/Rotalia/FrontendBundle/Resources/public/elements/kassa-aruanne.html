<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="kassa-behavior.html">
<link rel="import" href="kassa-page-behavior.html">
<link rel="import" href="kassa-equal-columns-behavior.html">
<link rel="import" href="kassa-confirm-button.html">
<link rel="import" href="kassa-aruanne-sularaha.html">
<link rel="import" href="kassa-aruanne-summary.html">
<link rel="import" href="kassa-aruanne-toode.html">

<dom-module id="kassa-aruanne">
    <template>
        <style>
            main {
                padding-bottom: 500px;
            }

            .split-h {
                display: flex;
                flex-flow: row wrap;
                justify-content: space-between;
                padding: 1em;
            }

            .split-v {
                display: flex;
                flex-flow: column nowrap;
                justify-content: flex-start;
                align-items: center;
                flex: 2 1 21em;
            }

            #tooted {
                display: flex;
                flex-flow: row wrap;
                width: 100%;
            }

            kassa-aruanne-sularaha {
                flex: 1 2 21em;
            }

            kassa-double-confirm-button {
                width: 100%;
                max-width: 15em;
            }

            paper-textarea {
                width: 100%;
                max-width: 30em;
            }

            [data-invisible] {
                visibility: hidden;
            }


        </style>

        <main hidden$="[[loading]]">
            <paper-material class="split-h">
                <span>Eelmise valvearuande koostas [[pageData.prev_koostaja]] [[pageData.prev_aeg]].</span>
            </paper-material>

            <div id="tooted">
                <template is="dom-repeat" items="{{pageData.tooted}}" as="toode">
                    <kassa-aruanne-toode kassa-columns-item fixed="[[aruanneFixed]]" toode="{{toode}}"
                                         data-invisible$="[[_computeHiddenIndex(index, lastIndex)]]" data-index$="[[index]]"
                                         on-kogus-confirmed="_kogusConfirmed" on-dom-change="setColumnWidth"></kassa-aruanne-toode>
                </template>
            </div>

            <paper-material hidden$="[[_computeSummaryHidden(lastIndex, pageData)]]" class="split-h">
                <kassa-aruanne-sularaha hidden$="[[!pageData.sularaha]]" fixed="[[aruanneFixed]]" sularaha-postkasti-varem="[[pageData.sularaha_postkasti]]"
                                        sularaha-kassas="{{sularahaKassas}}" sularaha-postkasti="{{sularahaPostkasti}}"></kassa-aruanne-sularaha>
                <div class="split-v">
                    <paper-textarea label="Kommentaar" disabled="[[aruanneFixed]]" value="{{aruanneKommentaar}}"></paper-textarea>
                    <kassa-confirm-button confirmed="{{aruanneFixed}}" double-confirm
                                          on-kassa-confirm="_calcSummary" on-kassa-double-confirm="_kinnitaAruanne">Salvest Aruanne</kassa-confirm-button>
                    <kassa-aruanne-summary tooted="[[pageData.tooted]]" hidden$="[[!aruanneFixed]]"
                                       sularaha-kasutusel="[[pageData.sularaha]]" sularaha-summa="[[sularahaKassas]]"
                                       sularaha-alguses="[[pageData.prev_sularaha]]" sularaha-postkasti="[[sularahaPostkasti]]"></kassa-aruanne-summary>
                </div>
            </paper-material>
        </main>

    </template>
    <script>
        Polymer({
            is: "kassa-aruanne",
            properties: {
                lastIndex: {
                    type: Number,
                    value: 0,
                    readOnly: true
                }
            },
            behaviors: [PageBehavior, KassaBehavior, EqualColumnsBehavior],

            cleanUp: function () {
                this._setLastIndex(0);
                this.set('pageData.tooted', []);
                this.set('aruanneFixed', false);
                this.set('aruanneKommentaar', '');
                
                const sularaha = this.querySelector('kassa-aruanne-sularaha')
                if (sularaha) {
                    sularaha.cleanUp();
                }
            },
            _kinnitaAruanne: function (e) {

                var makeAruanneBody = {
                    sularaha: this.sularahaKassas,
                    sularahaPostkasti: this.sularahaPostkasti - this.pageData.sularaha_postkasti,
                    kommentaar: this.aruanneKommentaar,
                    tooted: []
                };

                for (var i=0; i < this.pageData.tooted.length; i++) {
                    makeAruanneBody.tooted.push({
                        'id': this.pageData.tooted[i].id,
                        'kogus': this.pageData.tooted[i].kogusTegelik
                    });
                }

                this.$.makeAruanneRequest.body = makeAruanneBody;
                this.$.makeAruanneRequest.generateRequest();

            },
            _onAruanneSuccess: function (e) {
                this.fire('kassa-message-success', 'Aruanne edukalt kinnitatud!')
                this.cleanUp();
                this.$$('#aruanneRequest').generateRequest();
            },
            _onAruanneError: function (e) {
                this.fire('kassa-message-error', e.detail.message);
                this.set('aruanneFixed', false);
            },
            _kogusConfirmed: function(e){
                var index = e.model.__data__.index;
                if (index == this.lastIndex) {
                    this._setLastIndex(index+1)
                }

                if(this.lastIndex < this.pageData.tooted.length) {
                    if (this.lastIndex == index+1) {
                        this.fire('kassa-scroll-to-pos',
                            {pos: this.querySelector('kassa-aruanne-toode[data-index="' + this.lastIndex + '"]').getBoundingClientRect().top - this.getBoundingClientRect().top});

                    }
                } else {
                    //this.fire('kassa-scroll-to-pos', {pos: 0});
                }

            },
            _computeHiddenIndex: function (index, lastIndex) {
                return index > lastIndex
            },
            _computeSummaryHidden: function (lastIndex, pageData) {
                if(!pageData.tooted) {
                    return true
                }
                return lastIndex < pageData.tooted.length
            },
            _calcSummary: function (e) {
                this.querySelector('kassa-aruanne-summary').calcSummary()
            }
        })
    </script>
</dom-module>