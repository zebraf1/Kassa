<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<link rel="import" href="kassa-ost-tootegrupp.html">
<link rel="import" href="kassa-ost-toode-valitud.html">
<link rel="import" href="kassa-confirm-button.html">

<link rel="import" href="kassa-page-behavior.html">
<link rel="import" href="kassa-behavior.html">

<dom-module id="kassa-ost">
    <template>
        <style>
            main {
                display: flex;
                flex-flow: column nowrap;
                padding-bottom: 300px;
            }

            .split-h {
                display: flex;
                flex-flow: row wrap;
                justify-content: space-between;
                align-items: center;
                padding: 1em;
            }
            
            .split-h span, kassa-confirm-button {
                margin-left: auto;
            }

        </style>

        <iron-a11y-keys target="[[tasujaComboBox]]" keys="enter" on-keys-pressed="_selectFilterInput"></iron-a11y-keys>
        <iron-a11y-keys target="[[filterInput]]" keys="enter" on-keys-pressed="_selectToode"></iron-a11y-keys>
        <iron-a11y-keys target="[[tooteKogusInput]]" keys="esc" on-keys-pressed="_dismissTooteKogusDialog"></iron-a11y-keys>
        <iron-a11y-keys target="[[tooteKogusInput]]" keys="enter" on-keys-pressed="_confirmTooteKogusDialog"></iron-a11y-keys>


        <main id="mainContent">
            <paper-material class="split-h">
                <vaadin-combo-box id="tasujaComboBox" label="Tasuja" value="[[member.id]]"
                                  disabled="[[ostFixed]]" on-focusin="_selectTasujaComboBox" on-focusout="_onFocusoutTasuja"
                                  item-label-path="name" item-value-path="id" items="[[members]]"></vaadin-combo-box>

                <span style="font-size: 1.8em">Summa: [[_computeOstSumma(chosenProducts.*)]]</span>
            </paper-material>

            <template is="dom-repeat" items="[[chosenProducts]]" as="product">
                <kassa-ost-valitud-toode product="[[product]]" on-tap="_removeChosenProduct" fixed="[[ostFixed]]"></kassa-ost-valitud-toode>
            </template>


            <paper-material class="split-h">
                <paper-input id="filterInput" disabled="[[ostFixed]]" label="Otsi Toodet" value="{{filterVal}}" on-focusin="_selectFilterInput"></paper-input>
                <kassa-confirm-button disabled$="[[!chosenProducts.length]]" confirmed="{{ostFixed}}" double-confirm
                                      on-kassa-confirm="_confirmOst" on-kassa-double-confirm="_doubleConfirmOst">Osta</kassa-confirm-button>
            </paper-material>

            <template is="dom-repeat" items="[[_computeProductGroups(productGroups, products)]]" as="productGroup">
                <kassa-ost-tootegrupp products="[[productGroup.products]]" filter-val="[[filterVal]]"
                                      on-kassa-select-product="_onToodeValitud">[[productGroup.name]]</kassa-ost-tootegrupp>
            </template>
        </main>


        <paper-dialog id="tooteKogusDialog" modal>
            <paper-material class="split-h">
                <span class="expanding">[[valitudToode.name]]</span>
                <paper-input id="tooteKogusInput" type="number" min="1" step="1" no-label-float style="flex: 0 1 3em"
                             value="{{valitudToode.valitudKogus}}" autofocus></paper-input>
                <span style="text-align:right"> &times; [[formatAmount(valitudToode.amount, valitudToode.amountType)]]</span>
                <span style="text-align:right">[[_computeHind(valitudToode.valitudKogus, valitudToode.price)]]</span>
            </paper-material>

            <div class="buttons">
                <paper-button dialog-dismiss>Katkesta</paper-button>
                <paper-button dialog-confirm on-tap="_onToodeLisatud">Lisa toode</paper-button>
            </div>
        </paper-dialog>

    </template>
    <script>
        Polymer({
            is: "kassa-ost",
            properties: {
                member: {
                    type: Object
                },
                members: {
                    type: Array
                },
                products: {
                    type: Array
                },
                productGroups: {
                    type: Array
                },
                conventId: {
                    type: Number
                },
                //Delay timer kahe lisatava toote vahel
                _nextAllowedTime: {
                    type: Number,
                    value: 0,
                    readOnly: true
                }
            },
            behaviors: [PageBehavior, KassaBehavior],
            observers: ['_loadProducts(pageActive, member.selectedConventId)'],
            ready: function () {
                // Key bindingute jaoks (a11y-keys)
                this.tasujaComboBox = this.$.tasujaComboBox;
                this.filterInput = this.$.filterInput;
                this.tooteKogusInput = this.$.tooteKogusInput;
            },
            setUp: function () {
                this.chosenProducts = [];
                this.fire('kassa-backend-action', {action: 'doMembersGet'});
            },
            cleanUp: function () {
                if (this.member) {
                    this.$.tasujaComboBox.value = this.member.id;    
                }
                this.set('ostFixed', false);
            },
            _computeOstSumma: function (chosenProducts) {
                //Arvutab kuvamiseks ostu summa
                var summa = 0;

                for(var i = 0; i < chosenProducts.base.length; i++) {
                    summa += this.eur2cent(chosenProducts.base[i].summa);
                }

                return this.cent2str(summa)
            },
            _computeHind: function (kogus, hind) {
                //Valitud toote hind
                return this.eur2str(Math.floor(kogus)*hind)
            },
            _confirmOst: function () {
                // Tasuja väli peab olema täidetud
                this._onFocusoutTasuja();
            },
            _selectToode: function () {
                var productGroups = this.$.mainContent.querySelectorAll('kassa-ost-tootegrupp');
                for(var i=0; i<productGroups.length; i++) {
                    if(productGroups[i].selectFirst()) {
                        return null
                    }
                }
            },
            _dismissTooteKogusDialog: function () {
                this.$.tooteKogusDialog.close();
                this._selectFilterInput();
            },
            _confirmTooteKogusDialog: function () {
                this.$.tooteKogusDialog.close();
                this._onToodeLisatud();
                this._selectFilterInput();
            },
            _onToodeValitud: function (e) {
                //Avame toote koguse valimis dialoogi
                if (!this.ostFixed && Date.now() > this._nextAllowedTime) {
                    this.valitudToode = e.detail;
                    this.set('valitudToode.valitudKogus', "1");
                    this.set('filterVal', '');
                    this.$.tooteKogusDialog.open();
                }
            },
            _onToodeLisatud: function () {
                //Toode on lisatud valitud toodete hulka

                //Puutetundlikul ekraanil on vaja väikest delayd.
                this._set_nextAllowedTime(Date.now() + 200);
                //Teeme nö deep-copy
                this.push('chosenProducts',
                        {id: this.valitudToode.id, name: this.valitudToode.name,
                         size: this.formatAmount(this.valitudToode.amount, this.valitudToode.amountType), 
                         valitudKogus: Math.floor(this.valitudToode.valitudKogus),
                         summa: this.valitudToode.price*Math.floor(this.valitudToode.valitudKogus)});
                
                this.async(function() {
                    this._selectFilterInput();
                });
            },
            _selectTasujaComboBox: function () {
                this.$.tasujaComboBox.inputElement.select();
            },
            _onFocusoutTasuja: function () {
                //Tühja tasuja korral on kasutaja ise tasuja
                if (this.$.tasujaComboBox.value === ''){
                    this.$.tasujaComboBox.value = this.member.id;
                }
            },
            _selectFilterInput: function () {
                this.$.filterInput.inputElement.select();
            },
            _removeChosenProduct: function (event) {
                if (!this.ostFixed && (Polymer.dom(event).rootTarget.id == "icon" || Polymer.dom(event).rootTarget.localName === "paper-icon-button")) {
                    this.splice('chosenProducts', event.model.__data__.index, 1);
                }
            },
            _loadProducts: function(pageActive, conventId) {
                if(pageActive) {
                    this.fire('kassa-backend-action', {action: 'doProductsGetActive', conventId: conventId});
                    this.fire('kassa-backend-action', {action: 'doProductGroupsGet'}); 
                }
            },
            _computeProductGroups: function(productGroups, products){
                var groups = {};
                
                for(var i=0; i<products.length; i++) {
                    var product = products[i];
                    if(!groups[product.productGroupId]) {
                        groups[product.productGroupId] = [];
                    }
                    
                    groups[product.productGroupId].push(product);
                }

                var result = []
                for(var i=0; i<productGroups.length; i++) {
                    result.push({name: productGroups[i].name, products: typeof groups[productGroups[i].id] === 'undefined' ? [] : groups[productGroups[i].id]});
                }
                
                if(this.isTrue(groups[null])) {
                    result.push({name: 'Grupeerimata', products: groups[null]});
                }

                return result
            }
        })
    </script>
</dom-module>



